<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grammar Infographic & Workbook - Unit 8</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* 全体的なフォント設定：英語はTimes New Roman、日本語はNoto Sans JPを優先 */
        /* !important を使用してTailwindのデフォルトスタイルを確実に上書きします */
        body {
            font-family: 'Times New Roman', Times, 'Noto Sans JP', serif !important;
            font-size: 26px; /* ベースフォントサイズ */
        }
        
        /* 英文フォント強制適用クラス */
        .font-times {
            font-family: 'Times New Roman', Times, serif !important;
        }

        /* 見出しのサイズを相対的に調整 */
        h1 { font-size: 2.5em; }
        h2 { font-size: 2em; }
        h3 { font-size: 1.7em; }
        h4 { font-size: 1.5em; }
        
        /* 段落、ボタンなど主要なテキスト要素のサイズを統一 */
        p, div, span, button {
            font-size: 1em;
        }

        .tab-active {
            border-bottom-color: #ffffff;
            color: #ffffff;
            font-weight: 600;
        }
        .page {
            display: none;
        }
        .page-active {
            display: block;
        }
        .infographic-card {
            background-color: white;
            border-radius: 1rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            padding: 2.5rem;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .infographic-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        .audio-btn-small {
            padding: 0.5rem 1rem;
        }
        .pdf-btn {
            font-size: 0.8em;
            padding: 0.5em 1em;
        }
        .jp-explanation {
            font-size: 0.9em;
            color: #4b5563; /* gray-600 */
            margin-top: 0.75rem;
            font-family: 'Noto Sans JP', sans-serif !important; /* 日本語訳は読みやすさのためゴシック体に */
        }
        .recording {
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }
    </style>
</head>
<body class="bg-indigo-700 text-gray-800">

    <div class="container mx-auto p-4 md:p-8">
        <header class="text-center mb-10">
            <h1 class="font-bold text-white font-times">English Grammar Hub</h1>
            <p class="text-indigo-200 mt-2 font-times">Unit 8: How do cultures and traditions affect teens' lives?</p>
        </header>

        <!-- タブナビゲーション -->
        <div class="mb-10 border-b border-indigo-500">
            <nav class="flex justify-center -mb-px space-x-8" aria-label="Tabs">
                <button onclick="changeTab('infographic')" class="tab-btn tab-active whitespace-nowrap py-4 px-2 border-b-2 font-medium font-times" id="tab-infographic">
                    <i class="fas fa-chart-pie mr-2"></i>Infographic
                </button>
                <button onclick="changeTab('workbook')" class="tab-btn whitespace-nowrap py-4 px-2 border-b-2 border-transparent text-indigo-300 hover:text-white hover:border-gray-300 font-medium font-times" id="tab-workbook">
                    <i class="fas fa-pencil-alt mr-2"></i>Workbook
                </button>
            </nav>
        </div>

        <!-- ページコンテンツ -->
        <main>
            <!-- ページ1: インフォグラフィック -->
            <div id="page-infographic" class="page page-active">
                 <div class="text-right mb-4">
                    <button onclick="downloadPdf('infographic-content', 'Unit8_Infographic.pdf')" class="pdf-btn bg-white hover:bg-gray-100 text-indigo-700 font-bold rounded-lg shadow-md transition duration-300">
                        <i class="fas fa-file-pdf mr-2"></i>PDFでダウンロード
                    </button>
                </div>
                <div id="infographic-content">
                    <div class="grid grid-cols-1 gap-10 max-w-5xl mx-auto">
                        <!-- G18: 関係代名詞 what -->
                        <div class="infographic-card printable-section">
                            <h2 class="font-bold text-indigo-600 mb-4 font-times">G18: 関係代名詞 what</h2>
                            <p class="mb-4 font-times">「～するもの」「～すること」という意味を表します。先行詞を含んでおり、<em>the thing(s) which</em> に相当します。</p>
                            
                            <div class="bg-indigo-50 p-5 rounded-lg mb-6">
                                <p class="font-times text-center text-indigo-800 text-xl font-bold">what + S + V ... / what + V ...</p>
                            </div>
                            
                            <div class="p-4 bg-sky-50 rounded-md">
                                <div class="flex justify-between items-center">
                                    <p class="font-times text-lg">I am sorry about <strong class="text-blue-600">what</strong> happened yesterday.</p>
                                    <div class="flex space-x-2">
                                        <button onclick="speakText(this.parentElement.previousElementSibling.textContent)" class="audio-btn-small bg-green-500 hover:bg-green-600 text-white font-bold rounded-md transition duration-300 flex items-center"><i class="fas fa-volume-up"></i></button>
                                        <button onclick="startRecording(this, this.parentElement.previousElementSibling.textContent)" class="audio-btn-small bg-red-500 hover:bg-red-600 text-white font-bold rounded-md transition duration-300 flex items-center"><i class="fas fa-microphone"></i></button>
                                    </div>
                                </div>
                                <div class="text-center mt-2 text-sm result-display"></div>
                                <p class="jp-explanation">（昨日起きたことについて申し訳なく思います。）</p>
                            </div>
                        </div>

                        <!-- G19: 関係代名詞の非制限用法 -->
                        <div class="infographic-card printable-section">
                            <h2 class="font-bold text-pink-600 mb-4 font-times">G19: 非制限用法</h2>
                            <p class="mb-4 font-times">関係代名詞の前にコンマ(,)を置いて、先行詞について補足的に情報を加えます。「…だが、それは～」のように訳し下します。</p>

                            <div class="bg-pink-50 p-5 rounded-lg mb-6">
                                <p class="font-times text-center text-pink-800 text-xl font-bold">先行詞, which / who ...</p>
                            </div>
                            
                            <div class="p-4 bg-pink-50 rounded-md">
                                <div class="flex justify-between items-center">
                                    <p class="font-times text-lg">She has two daughters, <strong class="text-pink-600">who</strong> are 12 and 16.</p>
                                     <div class="flex space-x-2">
                                        <button onclick="speakText(this.parentElement.previousElementSibling.textContent)" class="audio-btn-small bg-green-500 hover:bg-green-600 text-white font-bold rounded-md transition duration-300 flex items-center"><i class="fas fa-volume-up"></i></button>
                                        <button onclick="startRecording(this, this.parentElement.previousElementSibling.textContent)" class="audio-btn-small bg-red-500 hover:bg-red-600 text-white font-bold rounded-md transition duration-300 flex items-center"><i class="fas fa-microphone"></i></button>
                                    </div>
                                </div>
                                <div class="text-center mt-2 text-sm result-display"></div>
                                <p class="jp-explanation">（彼女には2人の娘がいますが、(その娘たちは)12歳と16歳です。）</p>
                            </div>
                        </div>
                        
                        <!-- Language Focus: Conjunctions -->
                        <div class="infographic-card printable-section">
                            <h2 class="font-bold text-orange-600 mb-4 font-times">Language Focus: 接続詞</h2>
                            <p class="mb-4 font-times">文の中で理由・条件・譲歩などを表す接続詞です。文脈に応じて使い分けましょう。</p>
                             <div class="bg-orange-50 p-5 rounded-lg mb-6">
                                <p class="font-times text-center text-orange-800 text-xl font-bold">unless (～でない限り) / even if (たとえ～でも)</p>
                            </div>
                            <div class="p-4 bg-orange-50 rounded-md">
                                <div class="flex justify-between items-center mt-2">
                                    <p class="font-times text-lg">I can get to the park before 1 p.m. <strong class="text-orange-600">unless</strong> the train is delayed.</p>
                                     <div class="flex space-x-2">
                                        <button onclick="speakText(this.parentElement.previousElementSibling.textContent)" class="audio-btn-small bg-green-500 hover:bg-green-600 text-white font-bold rounded-md transition duration-300 flex items-center"><i class="fas fa-volume-up"></i></button>
                                        <button onclick="startRecording(this, this.parentElement.previousElementSibling.textContent)" class="audio-btn-small bg-red-500 hover:bg-red-600 text-white font-bold rounded-md transition duration-300 flex items-center"><i class="fas fa-microphone"></i></button>
                                    </div>
                                </div>
                                <div class="text-center mt-2 text-sm result-display"></div>
                                 <p class="jp-explanation">（電車が遅れない限り、午後1時前に公園に到着できます。）</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ページ2: ワークブック -->
            <div id="page-workbook" class="page">
                <div class="flex justify-end mb-4 space-x-4">
                    <button onclick="downloadWorkbookPdf(false)" class="pdf-btn bg-white hover:bg-gray-100 text-indigo-700 font-bold rounded-lg shadow-md transition duration-300">
                        <i class="fas fa-file-pdf mr-2"></i>問題PDF
                    </button>
                    <button onclick="downloadWorkbookPdf(true)" class="pdf-btn bg-white hover:bg-gray-100 text-indigo-700 font-bold rounded-lg shadow-md transition duration-300">
                        <i class="fas fa-file-signature mr-2"></i>解答PDF
                    </button>
                </div>
                <div id="workbook-container" class="space-y-8">
                    <!-- JavaScriptで問題がここに挿入されます -->
                </div>
            </div>
        </main>
    </div>

    <script>
        const { jsPDF } = window.jspdf;
        let recognition;
        let currentRecordButton = null;
        let voices = [];

        // --- START: Improved Lightweight Speech Synthesis ---
        function populateVoiceList() {
            voices = speechSynthesis.getVoices();
        }

        populateVoiceList();
        if (speechSynthesis.onvoiceschanged !== undefined) {
            speechSynthesis.onvoiceschanged = populateVoiceList;
        }

        function speakText(text) {
            if (speechSynthesis.speaking) {
                speechSynthesis.cancel();
            }
            const cleanText = text.replace(/"/g, '');
            const utterance = new SpeechSynthesisUtterance(cleanText);
            
            const googleVoice = voices.find(voice => voice.name === 'Google US English' && voice.lang.startsWith('en'));
            const microsoftVoice = voices.find(voice => voice.name === 'Microsoft David - English (United States)' && voice.lang.startsWith('en'));

            if (googleVoice) {
                utterance.voice = googleVoice;
            } else if (microsoftVoice) {
                utterance.voice = microsoftVoice;
            } else {
                utterance.lang = 'en-US';
            }
            
            speechSynthesis.speak(utterance);
        }
        // --- END: Improved Lightweight Speech Synthesis ---


        // Speech Recognition setup
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (SpeechRecognition) {
            recognition = new SpeechRecognition();
            recognition.continuous = false;
            recognition.lang = 'en-US';
            recognition.interimResults = false;
            recognition.maxAlternatives = 1;

            recognition.onresult = (event) => {
                const speechResult = event.results[0][0].transcript;
                if (currentRecordButton) {
                    const targetText = currentRecordButton.dataset.targetText;
                    const resultEl = currentRecordButton.closest('.p-4, .p-5, .audio-record-block').querySelector('.result-display');
                    evaluateSpeech(speechResult, targetText, resultEl);
                }
            };

            recognition.onspeechend = () => {
                recognition.stop();
            };

            recognition.onend = () => {
                if(currentRecordButton) {
                    currentRecordButton.classList.remove('recording');
                    currentRecordButton.innerHTML = '<i class="fas fa-microphone"></i>';
                    currentRecordButton = null;
                }
            };

            recognition.onerror = (event) => {
                if (currentRecordButton) {
                    const resultEl = currentRecordButton.closest('.p-4, .p-5, .audio-record-block').querySelector('.result-display');
                    resultEl.innerHTML = `<span class="text-red-500">エラー: ${event.error}</span>`;
                    currentRecordButton.classList.remove('recording');
                    currentRecordButton.innerHTML = '<i class="fas fa-microphone"></i>';
                    currentRecordButton = null;
                }
            };
        }

        function startRecording(button, targetText) {
            if (!recognition) {
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
                modal.innerHTML = `
                    <div class="bg-white p-8 rounded-lg shadow-lg text-center">
                        <p class="text-lg mb-4">お使いのブラウザは音声認識に対応していません。</p>
                        <button onclick="this.parentElement.parentElement.remove()" class="bg-blue-500 text-white px-4 py-2 rounded-lg">OK</button>
                    </div>
                `;
                document.body.appendChild(modal);
                return;
            }
            if (currentRecordButton && currentRecordButton !== button) {
                recognition.stop();
            }
            
            currentRecordButton = button;
            button.dataset.targetText = targetText;
            const resultEl = button.closest('.p-4, .p-5, .audio-record-block').querySelector('.result-display');
            
            button.classList.add('recording');
            button.innerHTML = '<i class="fas fa-stop"></i>';
            resultEl.innerHTML = '<span class="text-gray-500">話してください...</span>';

            recognition.start();
        }

        function evaluateSpeech(speech, target, resultEl) {
            const cleanTarget = target.replace(/[.,?"']/g, "").toLowerCase();
            const cleanSpeech = speech.replace(/[.,?"']/g, "").toLowerCase();

            const targetWords = cleanTarget.split(' ');
            const speechWords = cleanSpeech.split(' ');
            
            let correctWords = 0;
            const uniqueTargetWords = [...new Set(targetWords)];
            speechWords.forEach(word => {
                if (uniqueTargetWords.includes(word)) {
                    correctWords++;
                }
            });

            const rawScore = (correctWords / uniqueTargetWords.length) * 100;
            
            let finalScore = 0;
            let feedback = '';

            if (rawScore >= 80) {
                finalScore = 100;
                feedback = '<span class="text-green-500 font-bold">素晴らしい！ ' + finalScore + '点です！</span>';
            } else if (rawScore >= 60) {
                finalScore = 90 + Math.floor(Math.random() * 5); // 90-94
                feedback = '<span class="text-yellow-500 font-bold">ほぼ完璧です！ ' + finalScore + '点！</span>';
            } else if (rawScore >= 40) {
                finalScore = 80 + Math.floor(Math.random() * 10); // 80-89
                feedback = '<span class="text-blue-500 font-bold">良いですね！ ' + finalScore + '点！</span>';
            } else {
                finalScore = 70 + Math.floor(Math.random() * 10); // 70-79
                feedback = '<span class="text-orange-500 font-bold">もう一度挑戦してみましょう！ ' + finalScore + '点</span>';
            }
            resultEl.innerHTML = `認識されたテキスト: "${speech}"<br>${feedback}`;
        }


        // ページ切り替え機能
        function changeTab(pageId) {
            const pages = document.querySelectorAll('.page');
            pages.forEach(page => page.classList.remove('page-active'));
            document.getElementById('page-' + pageId).classList.add('page-active');

            const tabs = document.querySelectorAll('.tab-btn');
            tabs.forEach(tab => {
                tab.classList.remove('tab-active');
                tab.classList.add('text-indigo-300', 'hover:text-white', 'border-transparent');
            });
            
            const activeTab = document.getElementById('tab-' + pageId);
            activeTab.classList.add('tab-active');
            activeTab.classList.remove('text-indigo-300', 'hover:text-white', 'border-transparent');
        }

        // PDFダウンロード機能
        async function createPdfFromElement(elementId, fileName, pdfFontSize) {
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF('p', 'mm', 'a4');
            const pdfWidth = pdf.internal.pageSize.getWidth();
            const pdfHeight = pdf.internal.pageSize.getHeight();
            const margin = 10;
            let y = margin;

            const originalElement = document.getElementById(elementId);
            const clone = originalElement.cloneNode(true);
            clone.id = `${elementId}-print-clone`;
            clone.style.position = 'absolute';
            clone.style.left = '-9999px';
            clone.style.width = originalElement.offsetWidth + 'px';
            document.body.appendChild(clone);

            if (pdfFontSize) {
                clone.style.fontSize = pdfFontSize;
                clone.querySelectorAll('*').forEach(el => {
                    el.style.fontSize = 'inherit';
                });
            }

            const sections = clone.querySelectorAll('.printable-section');

            for (const section of sections) {
                const canvas = await html2canvas(section, { scale: 2 });
                const imgData = canvas.toDataURL('image/png');
                const imgProps = pdf.getImageProperties(imgData);
                const imgHeight = (imgProps.height * (pdfWidth - margin * 2)) / imgProps.width;

                if (y + imgHeight > pdfHeight - margin) {
                    pdf.addPage();
                    y = margin;
                }

                pdf.addImage(imgData, 'PNG', margin, y, pdfWidth - margin * 2, imgHeight);
                y += imgHeight + 5; // セクション間のスペース
            }

            document.body.removeChild(clone);
            pdf.save(fileName);
        }

        async function downloadPdf(elementId, fileName) {
            await createPdfFromElement(elementId, fileName, '16px');
        }

        async function downloadWorkbookPdf(showAnswers) {
            const originalContainer = document.getElementById('workbook-container');
            const clone = originalContainer.cloneNode(true);
            clone.id = 'workbook-print-clone';
            clone.style.position = 'absolute';
            clone.style.left = '-9999px';
            clone.style.width = originalContainer.offsetWidth + 'px';
            document.body.appendChild(clone);

            if (showAnswers) {
                const questionItems = clone.querySelectorAll('.printable-section[data-question]');
                questionItems.forEach(item => {
                    const questionTextEl = item.querySelector('.text-gray-800.mb-4');
                    const qData = JSON.parse(item.dataset.question);
                    
                    if (qData.answer) {
                        let newHTML = qData.q;
                        const answerParts = qData.answer.split(',').map(s => s.trim());
                        let tempHTML = newHTML;
                        
                        if (qData.type.includes('並べかえ')) {
                             const answerHTML = `<strong style="color: red; font-weight: bold;">${qData.answer}</strong>`;
                             // Replace ( ... ) with correct answer
                             tempHTML = tempHTML.replace(/\(.*\)/, `(${answerHTML})`);
                        } else {
                             // Replace placeholders like ______
                             answerParts.forEach(part => {
                                const answerHTML = `<strong style="color: red; font-weight: bold;">${part}</strong>`;
                                tempHTML = tempHTML.replace(/_{2,}/, answerHTML);
                            });
                        }
                        newHTML = tempHTML;
                        questionTextEl.innerHTML = newHTML;
                    } 
                });
            }
            
            clone.querySelectorAll('button, .result-display, .answer-block').forEach(el => el.style.display = 'none');
            
            const fileName = showAnswers ? 'Unit8_Workbook_Answers.pdf' : 'Unit8_Workbook_Problems.pdf';
            await createPdfFromElement('workbook-print-clone', fileName, '16px');

            document.body.removeChild(clone);
        }

        const workbookData = [
            {
                title: "Reading 1 - Grammar and Expressions",
                sections: [
                    {
                        id: "A",
                        instruction: "日本語の意味に合うように，（　　）内の語（句）を並べかえなさい。",
                        questions: [
                            { 
                                type: "並べかえ", 
                                q: "1. 彼女が言ったことは私には理解できません。<br><span class='font-times'>( she / doesn’t / make / said / sense / what ) to me.</span>", 
                                answer: "What she said doesn’t make sense", 
                                fullSentence: "What she said doesn't make sense to me.", 
                                explanation: "先行詞を含む関係代名詞what「…すること［もの］」によって導かれる節を主語にします。make sense ＝「意味が通じる，道理にかなう」", 
                                translation: "彼女が言ったことは私には理解できません。" 
                            },
                            { 
                                type: "並べかえ", 
                                q: "2. 私は，森で聞こえたものを説明しようとしました。<br><span class='font-times'>I tried ( what / I / explain / to / heard ) in the forest.</span>", 
                                answer: "to explain what I heard", 
                                fullSentence: "I tried to explain what I heard in the forest.", 
                                explanation: "動詞explainの目的語として関係代名詞what節を続けます。", 
                                translation: "私は，森で聞こえたものを説明しようとしました。" 
                            },
                            { 
                                type: "並べかえ", 
                                q: "3. それは少女が欲しがっているものではないと思います。<br><span class='font-times'>I don’t think ( the girl / what / is / that / wants ).</span>", 
                                answer: "that is what the girl wants", 
                                fullSentence: "I don't think that is what the girl wants.", 
                                explanation: "thatの補語として関係代名詞what節を続けます。", 
                                translation: "それは少女が欲しがっているものではないと思います。" 
                            },
                            { 
                                type: "並べかえ", 
                                q: "4. 私は，私たちのチームが達成したことに感動しています。<br><span class='font-times'>I’m ( what / with / impressed / achieved / our team ).</span>", 
                                answer: "impressed with what our team achieved", 
                                fullSentence: "I'm impressed with what our team achieved.", 
                                explanation: "前置詞withの目的語として関係代名詞what節を続けます。", 
                                translation: "私は，私たちのチームが達成したことに感動しています。" 
                            }
                        ]
                    },
                    {
                        id: "B",
                        instruction: "意味の通る英文になるように，空所に適切な関係代名詞を入れなさい。",
                        questions: [
                            { 
                                type: "空所補充", 
                                q: "<span class='font-times'>1. My grandmother cooked a curry, ______ included Indian beans.</span>", 
                                answer: "which", 
                                fullSentence: "My grandmother cooked a curry, which included Indian beans.", 
                                explanation: "先行詞a curryについて，関係代名詞which以降で補足的に情報を加えています。",
                                translation: "祖母はカレーを作りましたが、それにはインドの豆が入っていました。"
                            },
                            { 
                                type: "空所補充", 
                                q: "<span class='font-times'>2. Ms. Garcia has a son, ______ has lived in Hawaii for two years.</span>", 
                                answer: "who", 
                                fullSentence: "Ms. Garcia has a son, who has lived in Hawaii for two years.", 
                                explanation: "先行詞は人（a son）なのでwhoを使います。",
                                translation: "ガルシアさんには息子がいますが、彼はハワイに2年間住んでいます。"
                            },
                            { 
                                type: "空所補充", 
                                q: "<span class='font-times'>3. He wears a white T-shirt, ______ he bought at a flea market.</span>", 
                                answer: "which", 
                                fullSentence: "He wears a white T-shirt, which he bought at a flea market.", 
                                explanation: "先行詞は物（a white T-shirt）なのでwhichを使います。",
                                translation: "彼は白いTシャツを着ていますが、それはフリーマーケットで買ったものです。"
                            },
                            { 
                                type: "空所補充", 
                                q: "<span class='font-times'>4. Mayu said she saw a ghost in the river, ______ was a complete lie.</span>", 
                                answer: "which", 
                                fullSentence: "Mayu said she saw a ghost in the river, which was a complete lie.", 
                                explanation: "ここでの先行詞は動詞saidの目的語である(that) she saw a ghost in the riverという節全体です。非制限用法のwhichは文全体を先行詞にできます。",
                                translation: "マユは川で幽霊を見たと言いましたが、それは真っ赤な嘘でした。"
                            }
                        ]
                    },
                     {
                        id: "C",
                        instruction: "日本語の意味に合うように，空所に適切な語を入れなさい。",
                        questions: [
                            { 
                                type: "空所補充", 
                                q: "1. 私はその科学用語の意味がわかりませんでした。<br><span class='font-times'>I couldn’t understand ______ the scientific term ______.</span>", 
                                answer: "what, meant", 
                                fullSentence: "I couldn’t understand what the scientific term meant.", 
                                explanation: "「その科学用語が意味すること」＝ what the scientific term meant。",
                                translation: "私はその科学用語の意味がわかりませんでした。"
                            },
                            { 
                                type: "空所補充", 
                                q: "2. 有名な作家であるミラー氏は，24歳で作家のキャリアを開始しました。<br><span class='font-times'>Mr. Miller, ______ is a renowned author, started his writing career at the age of 24.</span>", 
                                answer: "who", 
                                fullSentence: "Mr. Miller, who is a renowned author, started his writing career at the age of 24.", 
                                explanation: "非制限用法の関係代名詞は文中に挿入される場合もあります。",
                                translation: "有名な作家であるミラー氏は，24歳で作家のキャリアを開始しました。"
                            },
                            { 
                                type: "空所補充", 
                                q: "3. 私は，あなたが暇なときにしていることに興味があります，ケイティー。<br><span class='font-times'>I’m interested in ______ you ______ in your free time, Katy.</span>", 
                                answer: "what, do", 
                                fullSentence: "I’m interested in what you do in your free time, Katy.", 
                                explanation: "前置詞inの目的語になるwhat節です。",
                                translation: "私は，あなたが暇なときにしていることに興味があります，ケイティー。"
                            },
                            { 
                                type: "空所補充", 
                                q: "4. 兄は式典に参加しましたが，それは近くのコミュニティーセンターで開かれました。<br><span class='font-times'>My brother attended a ceremony, ______ ______ held in a community center nearby.</span>", 
                                answer: "which, was", 
                                fullSentence: "My brother attended a ceremony, which was held in a community center nearby.", 
                                explanation: "先行詞a ceremonyに対する非制限用法です。受動態(be held)にします。",
                                translation: "兄は式典に参加しましたが，それは近くのコミュニティーセンターで開かれました。"
                            },
                             { 
                                type: "空所補充", 
                                q: "5. 祖父が昨日私に話したことは本当に違いありません。<br><span class='font-times'>______ my grandfather ______ me yesterday must be true.</span>", 
                                answer: "What, told", 
                                fullSentence: "What my grandfather told me yesterday must be true.", 
                                explanation: "先行詞を含む関係代名詞whatによって導かれる節を主語に置きます。",
                                translation: "祖父が昨日私に話したことは本当に違いありません。"
                            },
                             { 
                                type: "空所補充", 
                                q: "6. ジョンは日本語試験に合格しましたが，それは私の予想通りでした。<br><span class='font-times'>John passed the Japanese exam, ______ I ______.</span>", 
                                answer: "which, expected", 
                                fullSentence: "John passed the Japanese exam, which I expected.", 
                                explanation: "前の文全体を先行詞とする非制限用法のwhichです。",
                                translation: "ジョンは日本語試験に合格しましたが，それは私の予想通りでした。"
                            }
                        ]
                    }
                ]
            }
        ];

        // ワークブックの問題を生成
        const workbookContainer = document.getElementById('workbook-container');

        workbookData.forEach(workbook => {
            const mainTitleEl = document.createElement('h2');
            mainTitleEl.className = 'font-bold text-white mb-6 printable-section font-times';
            mainTitleEl.textContent = workbook.title;
            workbookContainer.appendChild(mainTitleEl);

            workbook.sections.forEach(sectionData => {
                const sectionEl = document.createElement('div');
                sectionEl.className = 'bg-white p-6 rounded-xl shadow-md mb-8 printable-section';
                
                const sectionHeader = document.createElement('div');
                sectionHeader.className = 'flex items-center mb-4 border-b pb-3';
                const sectionIdEl = document.createElement('h3');
                sectionIdEl.className = 'font-bold text-indigo-600 mr-4 font-times';
                sectionIdEl.textContent = sectionData.id;
                const instructionEl = document.createElement('p');
                instructionEl.textContent = sectionData.instruction;
                sectionHeader.appendChild(sectionIdEl);
                sectionHeader.appendChild(instructionEl);
                sectionEl.appendChild(sectionHeader);

                const questionsListEl = document.createElement('div');
                questionsListEl.className = 'space-y-6';

                sectionData.questions.forEach((qData) => {
                    const questionItemEl = document.createElement('div');
                    questionItemEl.className = 'p-5 border border-gray-200 rounded-lg printable-section';
                    questionItemEl.dataset.question = JSON.stringify(qData);

                    const questionTextEl = document.createElement('p');
                    questionTextEl.className = 'text-gray-800 mb-4';
                    questionTextEl.innerHTML = qData.q;
                    questionItemEl.appendChild(questionTextEl);

                    const toggleBtn = document.createElement('button');
                    toggleBtn.className = 'toggle-btn bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-3 px-6 rounded-lg transition duration-300 ease-in-out flex items-center';
                    toggleBtn.innerHTML = '<i class="far fa-eye mr-2"></i> 解答を表示';
                    questionItemEl.appendChild(toggleBtn);
                    
                    const answerBlockEl = document.createElement('div');
                    answerBlockEl.className = 'answer-block hidden mt-4 space-y-4';
                    
                    if (qData.translation) {
                        const translationContainer = document.createElement('div');
                        translationContainer.className = 'p-4 bg-green-50 rounded-md';
                        const translationTitle = document.createElement('h4');
                        translationTitle.className = 'font-bold text-green-700 text-lg';
                        translationTitle.textContent = '日本語訳';
                        const translationText = document.createElement('p');
                        translationText.className = 'jp-explanation mt-1';
                        translationText.textContent = qData.translation;
                        translationContainer.appendChild(translationTitle);
                        translationContainer.appendChild(translationText);
                        answerBlockEl.appendChild(translationContainer);
                    }

                    if (qData.explanation) {
                        const explanationContainer = document.createElement('div');
                        explanationContainer.className = 'p-4 bg-gray-100 rounded-md';
                        const explanationTitle = document.createElement('h4');
                        explanationTitle.className = 'font-bold text-gray-700 text-lg';
                        explanationTitle.textContent = '解説';
                        const explanationText = document.createElement('p');
                        explanationText.className = 'jp-explanation mt-1';
                        explanationText.textContent = qData.explanation;
                        explanationContainer.appendChild(explanationTitle);
                        explanationContainer.appendChild(explanationText);
                        answerBlockEl.appendChild(explanationContainer);
                    }
                    
                    const audioRecordContainer = document.createElement('div');
                    audioRecordContainer.className = 'flex items-center space-x-4 audio-record-block p-4 bg-gray-50 rounded-md';

                    const audioBtn = document.createElement('button');
                    audioBtn.className = 'audio-btn bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-6 rounded-lg transition duration-300 ease-in-out flex items-center';
                    audioBtn.innerHTML = '<i class="fas fa-volume-up mr-2"></i> 音声再生';
                    audioBtn.onclick = () => {
                        speakText(qData.fullSentence);
                    };
                    audioRecordContainer.appendChild(audioBtn);

                    const recordBtn = document.createElement('button');
                    recordBtn.className = 'record-btn bg-red-500 hover:bg-red-600 text-white font-bold py-3 px-6 rounded-lg transition duration-300 ease-in-out flex items-center';
                    recordBtn.innerHTML = '<i class="fas fa-microphone mr-2"></i> 録音評価';
                    recordBtn.onclick = () => {
                        startRecording(recordBtn, qData.fullSentence);
                    };
                    audioRecordContainer.appendChild(recordBtn);

                    const resultEl = document.createElement('div');
                    resultEl.className = 'result-display text-sm mt-2 flex-1';
                    audioRecordContainer.appendChild(resultEl);
                    
                    answerBlockEl.appendChild(audioRecordContainer);
                    questionItemEl.appendChild(answerBlockEl);

                    toggleBtn.onclick = () => {
                        const isAnswerShown = !answerBlockEl.classList.contains('hidden');

                        if (isAnswerShown) { // 解答を非表示にする
                            questionTextEl.innerHTML = qData.q;
                            answerBlockEl.classList.add('hidden');
                            toggleBtn.innerHTML = '<i class="far fa-eye mr-2"></i> 解答を表示';
                        } else { // 解答を表示する
                            let newHTML = qData.q;
                            if (qData.answer) {
                                const answerParts = qData.answer.split(',').map(s => s.trim());
                                let tempHTML = newHTML;
                                
                                if (qData.type.includes('並べかえ')) {
                                    const answerHTML = `<strong class="text-red-600 font-bold font-times">${qData.answer}</strong>`;
                                    tempHTML = tempHTML.replace(/\(.*\)/, `(${answerHTML})`);
                                } else { // Handles 空所補充
                                    answerParts.forEach(part => {
                                        const answerHTML = `<strong class="text-red-600 font-bold font-times">${part}</strong>`;
                                        tempHTML = tempHTML.replace(/_{2,}/, answerHTML); // Replace one blank at a time
                                    });
                                }
                                newHTML = tempHTML;
                            }
                            questionTextEl.innerHTML = newHTML;
                            
                            answerBlockEl.classList.remove('hidden');
                            toggleBtn.innerHTML = '<i class="far fa-eye-slash mr-2"></i> 解答を非表示';
                        }
                    };

                    questionsListEl.appendChild(questionItemEl);
                });
                sectionEl.appendChild(questionsListEl);
                workbookContainer.appendChild(sectionEl);
            });
        });
    </script>
</body>
</html>